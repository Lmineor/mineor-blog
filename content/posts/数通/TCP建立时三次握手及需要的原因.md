---
title: TCP建立时三次握手及需要的原因
date: 2025-04-06
draft: false
tags:
  - 数通
---

# TCP三次握手

![三次握手](https://blog.mineor.xyz/images/network/tcp_create.png)

第一次握手🤝： 客户端向服务器发送连接请求报文段。**无应用层数据。**
	SYN=1，seq=x（随机）
第二次握手🤝： 服务器端为该TCP连接分配缓存和变量，并向客户端返回确认报文段，允许连接，**无应用层数据。**
	SYN=1，ACK=1，seq=y（随机），ack=x+1
第三次握手🤝： 客户端为该TCP连接分配缓存和变量，并向服务器端返回确认的确认，**可以携带数据。** 
	SYN=0，ACK=1，seq=x+1，ack=y+1


# 为什需要三次，两次不行吗？

假如现在客户端想向服务端进行握手，它发送了第一个连接的请求报文，但是由于网络信号差或者服务器负载过多，这个请求没有立即到达服务端，而是在某个网络节点中长时间的滞留了，以至于滞留到客户端连接释放以后的某个时间点才到达服务端，那么这就是一个失效的报文，但是服务端接收到这个失效的请求报文后，就误认为客户端又发了一次连接请求，服务端就会想向客户端发出确认的报文，表示同意建立连接。
假如不采用三次握手，那么只要服务端发出确认，表示新的建立就连接了。但是现在客户端并没有发出建立连接的请求，其实这个请求是失效的请求，一切都是服务端在自相情愿，因此客户端是不会理睬服务端的确认信息，也不会向服务端发送确认的请求，但是服务器却认为新的连接已经建立起来了，并一直等待客户端发来数据，这样的情况下，服务端的很多资源就没白白浪费掉了。
采用三次握手的办法就是为了防止上述这种情况的发生，比如就在刚才的情况下，客户端不会向服务端发出确认的请求，服务端会因为收不到确认的报文，就知道客户端并没有要建立连接，那么服务端也就不会去建立连接，这就是三次握手的作用

# SYN洪泛攻击
SYN泛洪攻击发生在OSI第四层，这种方式利用TCP协议的特性，就是三次握手。
攻击者发送TCP SYN，SYN是TCP三次握手中的第一个数据包，而当服务器返回ACK后，该攻击者就不对其进行再次确认，那这个TCP连接就处于挂起状态，也就是所谓的半连接状态，服务器收不到再确认的话，还会重复发送TCK给攻击者。这样会更加浪费服务器的资源。攻击者就对服务器发送非常大量的这种TCP连接，由于每一个都无法完成三次握手，所以在服务器上，这些TCP连接会因为挂起状态而消耗CPU和内存，最后服务器可能死机，就无法为正常用户提供服务。